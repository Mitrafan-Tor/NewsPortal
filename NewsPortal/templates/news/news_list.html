{% extends 'default.html' %}
{% load custom_filters %}
{% load custom_tags %}

{% block title %}
    Список новостей
{% endblock title %}

{% block content %}
   <div class="container mt-3">
       <form action="" method="get">
           {{ filterset.form.as_p }}
           <input type="submit" value="Найти" class="btn btn-primary" />
       </form>
       <h1>Все новости ({{ news_count }})</h1>

       <div class="news-list">
           {% if news %}
               {% for post in news %}
                   <div class="post">
                       <h3><a href="{% url 'biblio:news_detail' post.id %}">{{ post.title|censor }}</a></h3>
                       <div class="post-meta">
                           <p>
                               {{ post.created_at|date:"d.m.Y H:i" }} |
                               {{ post.preview|censor|truncatewords:20 }}
                           </p>
                           <h6>Категории:</h6>
                           <div class="categories-wrapper">
                               {% for category in post.categories.all %}
                                <div class="category-item" style="display: inline-block; margin-right: 15px; margin-bottom: 10px;">
                                    <span>{{ category.name }}</span>
                                    {% if user.is_authenticated %}
                                    <form action="{% url 'biblio:subscribe' category.id %}" method="post" style="display: inline; margin-left: 5px;">
                                        {% csrf_token %}
                                        <input type="hidden" name="next" value="{% url 'biblio:news_list' %}">
                                        <button type="submit" class="btn btn-sm {% if user in category.subscribers.all %}btn-outline-danger{% else %}btn-outline-primary{% endif %}" style="padding: 0.15rem 0.5rem; font-size: 0.8rem;">
                                            {% if user in category.subscribers.all %}Отписаться{% else %}Подписаться{% endif %}
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>
                                {% endfor %}
                           </div>
                       </div>
                   </div>
               {% endfor %}
           {% else %}
               <p>В этой категории новостей пока нет.</p>
           {% endif %}

           <div class="pagination">
               {% if page_obj.has_previous %}
                   <a href="?{% url_replace page=1 %}">1</a>
                   {% if page_obj.previous_page_number != 1 %}
                       ...
                       <a href="?{% url_replace page=page_obj.previous_page_number %}">{{ page_obj.previous_page_number }}</a>
                   {% endif %}
               {% endif %}

               {{ page_obj.number }}

               {% if page_obj.has_next %}
                   <a href="?{% url_replace page=page_obj.next_page_number %}">{{ page_obj.next_page_number }}</a>
                   {% if paginator.num_pages != page_obj.next_page_number %}
                       ...
                       <a href="?{% url_replace page=page_obj.paginator.num_pages %}">{{ page_obj.paginator.num_pages }}</a>
                   {% endif %}
               {% endif %}
           </div>
       </div>
   </div>
{% endblock content %}